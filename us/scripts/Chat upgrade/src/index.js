const $dd = require('./../../../js/drag-n-drop.js');
const bindEvent = require('./../../../js/bindEvents.js');
const $ls = require('./../../../js/ls.js');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
var $data;

upgrade();

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function upgrade(){
  var chat, dragZone, input, button;

  chat = document.querySelector('#chatbar');
  if(!chat) return;

  dragZone = chat.querySelector('td');
  dragZone.setAttribute('style', 'cursor: move;');

  $dd(chat, 'gw-chat-window', dragZone).bind();

  input = chat.querySelector('#saytext');
  button = chat.querySelector('input[type="submit"][value="Â»"]');

  load();
  loadText(input);

  bindEvent(input, 'onkeyup', saveText, [], null, true);
  bindEvent(button, 'onclick', clearText);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function saveText(node, e){
  $data.text = node.value;
  save();
  if(e.keyCode == 13) clearText();
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function loadText(input){
  if($data.text == '') return;
  input.value = $data.text;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function clearText(){
  $data.text = '';
  save();
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function load(){
  $data = $ls.load('gk_cu_data');

  if($data.text== null){
    $data = {
      text: ''
    };

    save();
  }
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function save(){
  $ls.save('gk_cu_data', $data);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

